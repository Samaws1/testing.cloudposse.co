version: 2

projects:

- name: "atlantis-repos"
  workflow: "make"
  dir: "conf/atlantis-repos"
  workspace: "default"
  terraform_version: "v0.11.7"
  autoplan:
    when_modified:
      - "*.tf"
      - "*.tfvars"
    enabled: true
  apply_requirements:
    - "approved"

- name: "alpinist-terraform"
  workflow: "terraform"
  dir: "conf/alpinist/terraform/"
  workspace: "default"
  terraform_version: "v0.11.7"
  autoplan:
    when_modified:
      - "*.tf"
    enabled: false
  apply_requirements:
    - "approved"

- name: "alpinist-cloudformation"
  workflow: "cloudformation"
  dir: "conf/alpinist/"
  autoplan:
    when_modified:
      - "*.yaml"
    enabled: false
  apply_requirements:
    - "approved"

workflows:
  # Make workflow
  make:
    plan:
      steps:
      - run: "make plan"
    apply:
      steps:
      - run: "make apply"


  # Standard terraform workflow
  terraform:
    plan:
      steps:
      - run: "init-terraform"
      - run: "terraform plan -no-color -input=false -var-file testing.tfvars -out $PLANFILE"
    apply:
      steps:
      - run: "init-terraform"
      - run: "terraform apply -no-color -input=false -var-file testing.tfvars $PLANFILE"

  # Lambda
  cloudformation:
    plan:
      steps:
      - run: "make cf/bucket 2>/dev/null || true" 
      - run: "make cf/package TEMPLATE_FILE=${PLANFILE}"
      - run: "make cf/plan TEMPLATE_FILE=${PLANFILE}"
    apply:
      steps:
      - run: "make cf/deploy TEMPLATE_FILE=$(PLANFILE}"
      - run: "make cf/sync"
